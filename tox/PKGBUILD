# Contributor: Marat "Morion" Talipov <morion.self@gmail.com>

pkgname=tox
_gitname='ProjectTox-Qt-GUI'
pkgver=0.1.0.0731.172ed2a
pkgrel=1
pkgdesc="FOSS instant messaging application aimed to replace Skype (GUI)"
arch=('i686' 'x86_64')
url="http://tox.im"
license=('GPLv3')
depends=('qt5-base' 'libsodium')
makedepends=('git' 'make')
conflicts=('tox-qt-gui')
replaces=('tox-qt-gui')
source=('git://github.com/nurupo/ProjectTox-Qt-GUI.git' 'tox.desktop' 'tox.png')
md5sums=('SKIP'
         '0e61ad99d2d2df76676d3f349818ce79'
         '293a990d452c61c9bbd75a2b769df896')

_gitroot='https://github.com/irungentoo/ProjectTox-Core.git'
_gitname2='ProjectTox-Core'

pkgver() {
  cd $_gitname
  echo "0.1.0.$(date +%m%d).`git describe --always | sed 's/-/./g'`"
}

build() {
	# get tox-core
  	cd $srcdir/$_gitname/submodules
	rm -R "$_gitname2"
	git clone --recursive "$_gitroot"

	# version
	sed -i "s|developers' test version, not for public use|Tox - $pkgver|g" $srcdir/$_gitname/src/mainwindow.cpp

  	cd $srcdir/$_gitname

	# create build folder
	if [[ -d build ]]; then
		rm -rf build
	fi

	mkdir build && cd build
	msg "Building ..." 
	qmake -Wall ../projectfiles/QtCreator/TOX-Qt-GUI.pro
	make
	msg "Done"
}

package() {
	cd $srcdir/$_gitname

	#dir
	install -dm 755 $pkgdir/usr/bin

	#bin file
	install -m 755 ./build/TOX-Qt-GUI $pkgdir/usr/bin/tox

	#desktop file
	install -D -m644 $srcdir/$pkgname.desktop $pkgdir/usr/share/applications/$pkgname.desktop
	install -D -m644 $srcdir/$pkgname.png $pkgdir/usr/share/icons/$pkgname.png
		 
	msg "Removing build directory ..."
	rm -rf build
	msg "Done"
}
